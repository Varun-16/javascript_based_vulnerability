require 'rubygems'
require 'stemmer'
require 'classifier'
require 'open-uri'
require 'nokogiri'
require_relative 'app.rb'

# Load previous classifications
not_vulnerable = []
vulnerable = []
Xsssite.all.each do |site|
	# puts site.status.to_s.strip
	if site.status.length == 9
		# puts site.domain.strip
		vulnerable += site.scripts
	else
		# puts site.domain
		not_vulnerable += site.scripts
	end
end
# not_funny = YAML::load_file('not_funny.yml')

# Create our Bayes / LSI classifier
$classifier = Classifier::Bayes.new('Vulnerable', 'Not vulnerable')

# # Train the classifier
not_vulnerable.each { |script| $classifier.train_not_vulnerable script.content }
vulnerable.each { |script| $classifier.train_vulnerable script.content }

not_vulnerable.each do |script| 
	if $classifier.classify script.content
	  puts script.content 
	end
end

puts "DONE!!"

not_vulnerable = []
vulnerable = []

def get_script site
	html = Nokogiri::HTML(open(site).read)
	scripts = []
	html.css('script').each do |script|
	    if not script.content.empty?
		  #Data here
		  scripts << script.content.strip
	    end
	end
	scripts
end

def check_site site
	get_script(site).each do |f|
		puts $classifier.classify f
		# puts f.class
		# if $classifier.classify f.to_s == "Vulnerable"
		# 	puts "Vulnerable"
		# end
	end
end

# check_site "http://www.google.com"

puts $classifier.classify "alert(document.cookie);"

# Xsssite.all.each do |site|
	# if site.category.strip != "XSS"
	# 	next
	# end
	# html = Nokogiri::HTML(open(site.mirror).read)
	# point = 0
	# html.css('script').each do |script|
	#     if not script.content.empty?
	# 		  #Data here
	# 		  js_script = Script.new
	# 		  js_script.content = script.content.strip
	# 		  if classifier.classify js_script.content == "Not vulnerable"
	# 		  	point += 1
	# 		  else
	# 		  	puts "Vulnerable site #{site.domain}"
	# 		  	# point -= 1
	# 		  end
	#     end
	# end
	# if point >= 0 
	# 	puts "Not vulnerable"
	# end
# end






# # Let's classify some new quotes

# puts classifier.classify "Peter: A boat's a boat but a box could be anything! It could even be a boat!"
# puts classifier.classify "Stewie: Damn you ice cream, come to my mouth! How dare you disobey me!"
# puts classifier.classify "Brian: I could take my sweater off too, but I think it's attached to my skin. "
# puts classifier.classify "Peter: Hey, anybody got a quarter? Bill Gates: What's a quarter? "
# puts classifier.classify "Peter: I had such a crush on her. Until I met you Lois. You're my silver medal. "
# puts classifier.classify "Meg: Excuse me, Mayor West? Adam West: How do you know my language? "
# puts classifier.classify "Meg: You could kill all the girls who are prettier than me. Death: Well, that would just leave England. "

# # Print the classifier itself
# p classifier